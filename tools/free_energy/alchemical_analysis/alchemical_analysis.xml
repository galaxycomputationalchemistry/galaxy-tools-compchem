<tool id="alchemical_analysis" name="Alchemical Analysis" version="1.0.2">
    <description>Analysis of alchemical free energy calculations</description> 
    <requirements>
         <requirement type="package" version="1.0.2">alchemical-analysis</requirement>
         <requirement type="package" version="2019.1">gromacs</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
       ln -s '$datain' ./data.tar &&
       tar xf ./data.tar && 
       #if $method.select_method == "gromacs":
            gmx bar -f data/md*.xvg  &>> '$output'
       #else if $method.select_method == "alchemical-analysis":
            mkdir ./RESULTS/ &&
            #if $method.lambda.skip_lambda == "no"
                alchemical_analysis -d data -o ./RESULTS -t '$method.temp' -s '$method.time' -c -q xvg -p '$method.prefix' -g -e -f 10 -w -u '$method.units' &>> '$output'
            #else if $method.lambda.skip_lambda == "yes"
                 alchemical_analysis -d data -o ./RESULTS -t '$method.temp' -s '$method.time' -k '$method.lambda.skiplambda' -c -q xvg -p '$method.prefix' -g -e -f 10 -w -u '$method.units' &>> '$output'
            #end if
       #end if
    ]]></command>
    <inputs>
    <param format="tar" name="datain" type="data" label="TI/FEP data output"/>
         <conditional name="method">
             <param name="select_method" type="select" label="Select the method for analysis">
                 <option value="gromacs">Use gromacs</option>
                 <option value="alchemical-analysis">Use alchemical-analysis</option>
             </param>
             <when value="gromacs">
             </when>
             <when value="alchemical-analysis">
                 <param name="prefix" type="text" value="md" label="Prefix for datafile sets" help="This should be md if you used the alchemical simulator tool"/>
                 <param name="temp" type="integer" value="300" label="Temperature (K)"/>
                 <param name="time" type="integer" value="0" label="Equilibration time (ps)" help="Discard data prior to this specified time as 'equilibration' data." />
                 <param name="units" type="select" label="Units to report energies" >
                     <option value="kcal">kcal</option>
                     <option value="kJ">kJ</option>
                     <option value="kBT">kBT</option>
                 </param>
                 <conditional name="lambda">
                     <param name="skip_lambda" type="select" label="Want to skip some lambda states?"  >
                         <option value="no">No</option>
                         <option value="yes">Yes</option>
                     </param>
                     <when value="no">
                     </when>
                     <when value="yes">
                     <param name="skiplambda" type="text" value="1-2-3" label="Indicies of lambda states to skip" help="Give lambda indices separated by '-' and they will be removed from the analysis."/>
                     </when>
                 </conditional>
             </when>
         </conditional>
    </inputs>
    <outputs>
        <data name="output" format="txt" label="output">
        </data>
        <data name="results" format="txt" from_work_dir="./RESULTS/results.txt" label="Results">
            <filter>method['select_method'] == 'alchemical-analysis'</filter>
        </data>
        <data name="change" format="txt" from_work_dir="./RESULTS/dF_t.txt" label="Free energy change dF(t)">
            <filter>method['select_method'] == 'alchemical-analysis'</filter>
        </data>
        <data name="convergence" format="png" from_work_dir="./RESULTS/dF_t.png" label="Convergence Plot dF(t)">
            <filter>method['select_method'] == 'alchemical-analysis'</filter>
        </data>
        <data name="overlap" format="png" from_work_dir="./RESULTS/O_MBAR.png" label="Overlap Matrix">
            <filter>method['select_method'] == 'alchemical-analysis'</filter>
        </data>
        <data name="cfm" format="png" from_work_dir="./RESULTS/cfm.png" label="Curve Fitting Method (CFM) based consistency inspector">
            <filter>method['select_method'] == 'alchemical-analysis'</filter>
        </data>
        <data name="df_state" format="png" from_work_dir="./RESULTS/dF_state_long.png" label="Free energy change breakdown">
            <filter>method['select_method'] == 'alchemical-analysis'</filter>
        </data>
        <data name="ti_plot" format="png" from_work_dir="./RESULTS/dhdl_TI.png" label="Thermodynamic Integration plot">
            <filter>method['select_method'] == 'alchemical-analysis'</filter>
        </data>
    </outputs>
    <tests>
         <test>
            <param name="datain" value="data.tar" ftype="tar"/>
            <param name="select_method" value="alchemical-analysis"/> 
            <param name="prefix" value="md"/>
            <param name="temp" value="300"/>
            <param name="time" value="0"/>
            <param name="units" value="kcal"/>
            <param name="lambda" value="no"/>
            <output name="change" file="dF_t.txt" />
        </test>
    </tests>  
    <help><![CDATA[   
.. class:: infomark
 
**What it does**
        

This tool can run analyse the alchemical free energy simulations.

_____


.. class:: infomark

**Input**

       - TAR archive file of the gromacs XVG files from free energy simulations.

_____

       
.. class:: infomark

**Output**

       - Report and free energy outputs.

From Alchemical Analysis,
 
       - Overlap matrix of free energy winddows (as PNG).
       - Convergance plot (as PNG).
       - Curve Fitting Method (CFM) based consistency inspector (as PNG).
       - Free energy change breakdown (as PNG).
       - hermodynamic Integration plot (as PNG).

    ]]></help>
    <citations>
      <citation type="doi">10.1007/s10822-015-9840-9</citation>
      <citation type="doi">10.1016/j.softx.2015.06.001</citation>
    </citations>
</tool>
