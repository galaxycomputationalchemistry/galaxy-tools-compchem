<tool id="biomd_neqgamma" name="dcTMD friction correction" version="0.@TOOL_VERSION@+galaxy@VERSION_SUFFIX@">
    <description>for calculating friction and free energy profiles from TMD ensembles</description>
    <macros>
        <token name="@TOOL_VERSION@">1.5.2</token>
        <token name="@VERSION_SUFFIX@">0</token>
    </macros>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">scipy</requirement>
        <requirement type="package" version="1.19.1">numpy</requirement>
        <requirement type="package" version="1.1.2">pandas</requirement>
    </requirements>
    <command><![CDATA[
        #for t in $xvgs:
            echo $t &>> ./xvgs.txt &&
        #end for

        python '$__tool_directory__/NEQGamma.py' 
            -i ./xvgs.txt
            -o outp.txt
            -ofrict ofrict.txt
            -vel '$vel'
            -T '$T'
            -av '$av'
            -sigma '$sigma'
            #if $json:
                -json '$json'
            #end if

    ]]></command>
    <inputs>
        <param type="data_collection" name="xvgs" label="XVG constraint force files" format="xvg" help="XVG files generated by GROMACS"/>
        <param type="data" name="json" optional="true" label="Ensemble subgroups" format="json" help="Optional: list of sub-ensembles in JSON format (e.g. produced by the 'Extract clusters' tool). If not specified, results will be calculated for the entire ensemble."/>
        <param label="Pull velocity in nm/ps of the TMD simulations" value="0.001" min="0" type="float" name="vel" argument="-vel"/>
        <param label="Temperature in K" value="300" min="0" type="float" name="T" argument="-T"/>
        <param label="Size of averaging window for displaying Gamma(x)" value="0" min="0" type="integer" name="av" argument="-av" help="Recommended: 4 to 20 per 100 data points."/>
        <param label="Sigma value for Gauss filter for displaying Gamma(x)" value="0" min="0" type="integer" name="sigma" argument="-sigma" help="Recommended: 4 per 100 data points."/>
    </inputs>
    <outputs>
        <collection name="outp_col" type="list" label="Free energy data">
            <discover_datasets pattern="(?P&lt;designation&gt;^cluster\d+)_outp\.txt$" ext="txt"/>
            <filter>json</filter>
        </collection>
        <collection name="outp_frict_col" type="list" label="Friction data">
            <discover_datasets pattern="(?P&lt;designation&gt;^cluster\d+)_ofrict\.txt$" ext="txt"/>
            <filter>json</filter>
        </collection>
        <data name="outp" from_work_dir="outp.txt" format="tabular" label="Free energy data">
            <filter>not json</filter>
        </data>
        <data name="outp_frict" from_work_dir="ofrict.txt" format="tabular" label="Friction data">
            <filter>not json</filter>
        </data>
    </outputs>
    <tests>
        <test>
            <param name="xvgs">
                <collection type="list">
                    <element name="pull1" ftype="xvg" value="pull1.xvg" />
                    <element name="pull2" ftype="xvg" value="pull2.xvg" />
                    <element name="pull3" ftype="xvg" value="pull3.xvg" />
                </collection>
            </param>
            <param name="vel" value="0.001" />
            <param name="T" value="300" />
            <param name="av" value="20" />
            <param name="sigma" value="20" />
            <output name="outp" value="NEQGamma_outp.txt" />
            <output name="outp_frict" value="NEQGamma_ofrict.txt" />
        </test>
        <test>
            <param name="xvgs">
                <collection type="list">
                    <element name="pull1" ftype="xvg" value="pull1.xvg" />
                    <element name="pull2" ftype="xvg" value="pull2.xvg" />
                    <element name="pull3" ftype="xvg" value="pull3.xvg" />
                </collection>
            </param>
            <param name="json" value="NEQGamma_clusters.json" />
            <param name="vel" value="0.001" />
            <param name="T" value="300" />
            <param name="av" value="20" />
            <param name="sigma" value="20" />
            <output_collection name="outp_col" type="list">
                <element name="cluster0" file="NEQGamma_outp1.txt"/>
                <element name="cluster1" file="NEQGamma_outp2.txt"/>
            </output_collection>
            <output_collection name="outp_frict_col" type="list">
                <element name="cluster0" file="NEQGamma_ofrict1.txt"/>
                <element name="cluster1" file="NEQGamma_ofrict2.txt"/>
            </output_collection>
        </test>

    </tests>
    <help><![CDATA[

.. class:: infomark

**What it does**

Perform dcTMD friction correction from an ensemble of XVG files generated by GROMACS targeted molecular dynamics (TMD) simulations.

_____


.. class:: infomark

**Input**

       - Ensemble of XVG files from TMD simulations
       - Optional: JSON file containing subgroups of trajectories from the ensemble. If this option is used, the dcTMD calculation will be performed separately for each sub-ensemble.

_____


.. class:: infomark

**Output**

       - Tab-separated files containing free energy and friction data.
]]></help>
    <citations>
        <citation type="doi">10.1021/acs.jctc.8b00835</citation>
    </citations>
</tool>

